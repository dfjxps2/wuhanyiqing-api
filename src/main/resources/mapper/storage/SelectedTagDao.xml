<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.dfjinxin.modules.storage.dao.SelectedTagDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.dfjinxin.modules.storage.entity.SelectedTagEntity" id="tagInfoMap">
        <result property="id" column="id"/>
        <result property="tagName" column="tag_name"/>
        <result property="tagCount" column="tag_count"/>
    </resultMap>

    <!--label目录表+label叶子联合的下拉树 treeSelect-->
    <select id="getDataForSelect" resultType="io.dfjinxin.modules.storage.tree.EntityTree">
        select c.Label_Catgid id ,c.Label_Catg_Nm label, c.Supr_Label_Catgid parentid  from label_catg c
        <where>
            c.tnmtid = #{tnmtId}
            <if test="catgyList!=null and catgyList.size()>0">
                and  c.Label_Catgid in
                <foreach collection="catgyList"  separator="," open="(" close=")" index="index" item="item">
                    #{item}
                </foreach>
            </if>
        </where>
        <!--union
        select CONCAT('leaf_',lb.labelid) as id ,lb.label_nm label,lb.label_catgid
        from label lb
        <where>
            <if test="leafList!=null and leafList.size()>0">
                lb.labelid in
                <foreach collection="leafList"  separator="," open="(" close=")" index="index" item="item">
                    #{item}
                </foreach>
            </if>
        </where>-->
    </select>

    <!--label目录表+label叶子 && 叶子上显示 数据表的数量 el-tree -->
    <select id="getDataForElAndCount" resultType="io.dfjinxin.modules.storage.tree.EntityTree">
        select c.Label_Catgid id ,c.Label_Catg_Nm label, c.Supr_Label_Catgid parentid,0 num  from label_catg c
        <where>
            c.tnmtid = #{tnmtId}
            <if test="catgyList!=null and catgyList.size()>0">
                and  c.Label_Catgid in
                <foreach collection="catgyList"  separator="," open="(" close=")" index="index" item="item">
                    #{item}
                </foreach>
            </if>
        </where>
        union
        select CONCAT('leaf_',lb.labelid) as id ,lb.label_nm label,lb.label_catgid parentid,(
        select count(*) as id from
        data_tbl_mark_idx dx
        INNER JOIN data_tbl dt ON dx.Data_Tblid=dt.Data_Tblid
        INNER JOIN label lb_t ON lb_t.labelid=dx.Labelid
        INNER JOIN db ON db.Dbid=dt.dbid
        INNER JOIN db_usage du ON db.db_usageid=du.db_usageid
        where
        dt.Del_Dt is NULL
        AND
        du.db_usage_cd  in('02','07','08')
        and
        lb_t.labelid=lb.labelid
        and
        lb_t.tnmtid = #{tnmtId}
        <if test="partId != null ">
            and db.Partid=#{partId}
        </if>
        <if test="dbId != null and  dbId != ''">
            and db.Dbid=#{dbId}
        </if>
        ) num
        from label lb
        <where>
            lb.tnmtid = #{tnmtId}
            <if test="leafList!=null and leafList.size()>0">
                and lb.labelid in
                <foreach collection="leafList"  separator="," open="(" close=")" index="index" item="item">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <!--label目录表+label叶子+数据表联合的下拉树-->
    <select id="getDataForEl" resultType="io.dfjinxin.modules.storage.tree.EntityTree">
        select c.Label_Catgid id ,c.Label_Catg_Nm label, c.Supr_Label_Catgid parentid,0 num  from label_catg c
        <where>
            c.tnmtid = #{tnmtId}
            <if test="catgyList!=null and catgyList.size()>0">
                and c.Label_Catgid in
                <foreach collection="catgyList"  separator="," open="(" close=")" index="index" item="item">
                    #{item}
                </foreach>
            </if>
        </where>
        union
        select CONCAT('leaf_',a.labelid) as id ,a.label_nm as label,a.label_catgid as parentid,
        (
        select count(DISTINCT CONCAT('table_',dx.Data_Tblid,'_',dx.labelid)) as id from
        data_tbl_mark_idx dx
        LEFT JOIN data_tbl dt ON dx.Data_Tblid=dt.Data_Tblid
        LEFT JOIN db on db.Dbid=dt.dbid
        left join db_usage du on db.Db_UsageId = du.Db_UsageId
        where dx.Labelid = a.Labelid
        and dt.Del_Dt is null
        and (du.Db_Usage_Cd = '02' or du.Db_Usage_Cd = '07' or du.Db_Usage_Cd = '08')
        and db.Partid=#{partId}
        <if test="dbId != null and  dbId != ''">
            and db.Dbid=#{dbId}
        </if>
        ) as num
        from label a
        <where>
            <if test="catgyList!=null and catgyList.size()>0">
                and a.Label_Catgid in
                <foreach collection="catgyList"  separator="," open="(" close=")" index="index" item="item">
                    #{item}
                </foreach>
            </if>
        </where>
        union
        select CONCAT('table_',dx.Data_Tblid,'_',dx.labelid) as id , if(dt.data_tbl_cn_nm <![CDATA[<>]]> '' and dt.data_tbl_cn_nm is not null, dt.data_tbl_cn_nm, dt.Data_Tbl_Phys_Nm) label ,
        CONCAT('leaf_',dx.labelid) parentid, 0 num from
        data_tbl_mark_idx dx
        LEFT JOIN data_tbl dt ON dx.Data_Tblid=dt.Data_Tblid
        LEFT JOIN db on db.Dbid=dt.dbid
        LEFT JOIN label lb on dx.Labelid = lb.Labelid
        left join db_usage du on db.Db_UsageId = du.Db_UsageId
        where dt.Del_Dt is null
        and (du.Db_Usage_Cd = '02' or du.Db_Usage_Cd = '07' or du.Db_Usage_Cd = '08')
        and db.Partid=#{partId}
        <if test="catgyList!=null and catgyList.size()>0">
            and lb.Label_Catgid in
            <foreach collection="catgyList"  separator="," open="(" close=")" index="index" item="item">
                #{item}
            </foreach>
        </if>
        <if test="dbId != null and  dbId != ''">
            and db.Dbid=#{dbId}
        </if>

    </select>


    <sql id="labelFilterCondition" >
        <where>
            dt.Del_Dt is NULL
            and
            du.db_usage_cd in('02','07','08')
            and
            l.tnmtid = #{tnmtId}
            <if test="leafList!=null and leafList.size()>0">
                and l.labelid in
                <foreach collection="leafList"  separator="," open="(" close=")" index="index" item="item">
                    #{item}
                </foreach>
            </if>
            <if test="partId!=null">
                and db.partid = #{partId}
            </if>
            <if test="dbId != null and  dbId != ''">
                and db.Dbid=#{dbId}
            </if>
        </where>
    </sql>
    <select id="getDetailCount" resultType="hashMap" >
        SELECT
            (
                SELECT
                  count(DISTINCT(dt.Data_Tblid))
                FROM
                    data_tbl_mark_idx dtmi
                    INNER JOIN data_tbl dt ON dtmi.Data_Tblid = dt.Data_Tblid
                    INNER JOIN db ON dt.Dbid = db.Dbid
                    INNER JOIN db_usage du ON db.db_usageid=du.db_usageid
                    INNER JOIN label l ON dtmi.labelid = l.labelid
                    <include refid = "labelFilterCondition" />
            ) AS tableAllCount,
            (
                SELECT
                    count(DISTINCT(dtmi.labelid))
                FROM
                    data_tbl_mark_idx dtmi
                    INNER JOIN data_tbl dt ON dtmi.Data_Tblid = dt.Data_Tblid
                    INNER JOIN db ON dt.Dbid = db.Dbid
                    INNER JOIN db_usage du ON db.db_usageid=du.db_usageid
                    INNER JOIN label l ON dtmi.labelid = l.labelid
                  <include refid = "labelFilterCondition" />
            ) AS tableTagAllCount,
            (
                SELECT
                  count(df2.fldid)
                FROM
                  data_fld df2
                WHERE
                  df2.Data_Tblid IN (
                    SELECT
                        DISTINCT(dt.Data_Tblid)
                    FROM
                        data_tbl_mark_idx dtmi
                        INNER JOIN data_tbl dt ON dtmi.Data_Tblid = dt.Data_Tblid
                        INNER JOIN db ON dt.Dbid = db.Dbid
                        INNER JOIN db_usage du ON db.db_usageid=du.db_usageid
                        INNER JOIN label l ON dtmi.labelid = l.labelid
                    <include refid = "labelFilterCondition" />
                  )
            ) AS filedAllCount,
            (
                    SELECT
                      count(DISTINCT(dfmi.labelid))
                    FROM
                        data_fld_mark_idx dfmi
                        INNER JOIN data_fld df ON dfmi.Fldid = df.Fldid
                        INNER JOIN label lb ON dfmi.labelid=lb.labelid
                    WHERE
                        lb.tnmtid=#{tnmtId}
                        <if test="leafList!=null and leafList.size()>0">
                            and dfmi.labelid in
                            <foreach collection="leafList"  separator="," open="(" close=")" index="index" item="item">
                                #{item}
                            </foreach>
                        </if>
                            AND dfmi.Fldid IN (
                            SELECT
                              (df2.fldid)
                            FROM
                              data_fld df2
                            WHERE
                            df2.Data_Tblid IN (
                                SELECT
                                  DISTINCT(dt.Data_Tblid)
                                FROM
                                    data_tbl_mark_idx dtmi
                                    INNER JOIN data_tbl dt ON dtmi.Data_Tblid = dt.Data_Tblid
                                    INNER JOIN db ON dt.Dbid = db.Dbid
                                    INNER JOIN db_usage du ON db.db_usageid=du.db_usageid
                                    INNER JOIN label l ON dtmi.labelid = l.labelid
                                    <include refid = "labelFilterCondition" />
                            )
                      )
            ) AS filedTagAllCount,
            (
                SELECT
                  sum(dp.Rec_Qty)
                  FROM
                    (
                      SELECT
                        <!--去重 防止计算多个table的记录数-->
                        DISTINCT(dt.Data_Tblid)
                      FROM
                        data_tbl_mark_idx dtmi
                        INNER JOIN data_tbl dt ON dtmi.Data_Tblid = dt.Data_Tblid
                        INNER JOIN db ON dt.Dbid = db.Dbid
                        INNER JOIN db_usage du ON db.db_usageid=du.db_usageid
                        INNER JOIN label l ON dtmi.labelid = l.labelid
                        <include refid = "labelFilterCondition" />
                    ) t
                    left  JOIN  dp on dp.Data_Tblid=t.Data_Tblid
                where
                    (dp.Data_Tblid,dp.Dp_Dt) in(
                        SELECT
                        dp.Data_Tblid,max(dp.Dp_Dt)
                        FROM
                        dp
                        GROUP BY dp.Data_Tblid
                    )
            ) AS tableAllRecord
        FROM
          DUAL
    </select>
    <!--   字段标签管理-标签视图-左侧标签列表
            根据分区、标签所属表、字段查询指定标签被使用的次数
            add by zhc 6.27
            -->
    <select id="queryFieldViewDataForEl" resultType="io.dfjinxin.modules.storage.tree.EntityTree">
        select c.Label_Catgid id ,c.Label_Catg_Nm label, c.Supr_Label_Catgid parentid  from label_catg c
        <where>
            <!-- 标签目录id-->
            <if test="catgyList!=null and catgyList.size()>0">
                c.Label_Catgid in
                <foreach collection="catgyList"  separator="," open="(" close=")" index="index" item="item">
                    #{item}
                </foreach>
            </if>
                and c.tnmtid = #{tnmtId}
        </where>
        union
        select CONCAT('leaf_',a.labelid) as id   ,CONCAT(a.label_nm,'(',(
        select count( DISTINCT CONCAT('fld_',dfmi.fldid,'_',dfmi.labelid)) as id from
        data_fld_mark_idx dfmi
        LEFT JOIN data_fld df on df.Fldid = dfmi.Fldid
        LEFT JOIN data_tbl dt on df.Data_Tblid = dt.Data_Tblid
        LEFT JOIN db ON db.Dbid=dt.dbid
        left join db_usage du on db.Db_Usageid= du.Db_UsageId
        LEFT JOIN label lb on dfmi.Labelid = lb.Labelid
        LEFT JOIN data_tbl_mark_idx dx on dx.Data_Tblid=dt.Data_Tblid
        WHERE lb.labelid = a.labelid
        <!-- 分区id-->
        and db.Partid=#{partId}
        <!-- 表未被删除-->
        and dt.Del_Dt is null
        and du.db_usage_cd in('02','07','08')
        <!-- 表标签选项：标签所在目录id-->
        <if test="leafList!=null and leafList.size()>0">
            and lb.Label_Catgid in
            <foreach collection="leafList"  separator="," open="(" close=")" index="index" item="item">
                #{item}
            </foreach>
        </if>
        <!-- 数据库id-->
        <if test="dbId != null ">
            and db.dbId=#{dbId}
        </if>
        ),')')  label,a.label_catgid
        from label a
        <where>
            a.Tnmtid=#{tnmtId}
            <!-- 字段标签labelid-->
            <if test="fldLabelList!=null and fldLabelList.size()>0">
                and a.labelid in
                <foreach collection="fldLabelList"  separator="," open="(" close=")" index="index" item="item">
                    #{item}
                </foreach>
            </if>
        </where>

    </select>
</mapper>