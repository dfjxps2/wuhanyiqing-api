<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.dfjinxin.modules.storage.dao.DesenDao">

    <resultMap type="io.dfjinxin.modules.meta.entity.DataTblEntity" id="dataTbDesenlMap">
        <result property="dataTblid" column="Data_Tblid"/>
        <result property="dbid" column="Dbid"/>
        <result property="dataTblPhysNm" column="Data_Tbl_Phys_Nm"/>
        <result property="dataTblCnNm" column="Data_Tbl_Cn_Nm"/>
        <result property="dataTblDesc" column="Data_Tbl_Desc"/>
        <result property="createDt" column="Create_Dt"/>
        <result property="updDt" column="Upd_Dt"/>
        <result property="delDt" column="Del_Dt"/>
        <result property="dbCnNm" column="Db_Cn_Nm"/>
    </resultMap>

    <select id="queryDesenDataCount" parameterType="io.dfjinxin.modules.storage.dto.DesenForm" resultType="java.lang.Integer">
        <!-- 字段中文名称Fld_Cn_Nm 字段英文名称Fld_Phys_Nm 表中文名称 表英文名称 脱敏算法 脱敏设置日期 -->
        SELECT
            count(*)
        FROM
            data_tbl tb
        WHERE
            tb.Del_Dt is null and
            tb.Dbid in (select db.Dbid from db db where db.Partid = #{param.partid})

            <!-- 如果填写表名称 -->
            <if test="param.tableName != null and param.tableName != ''">
                AND (tb.Data_Tbl_Cn_Nm like CONCAT('%', #{param.tableName, jdbcType=VARCHAR}, '%') OR tb.Data_Tbl_Phys_Nm like CONCAT('%', #{param.tableName, jdbcType=VARCHAR}, '%'))
            </if>

            <!-- 如果勾选了数据表标引 -->
            <if test="param.tableMarks!=null and param.tableMarks.length>0">
                AND  tb.Data_Tblid in
                (
                select tblmark.Data_Tblid from data_tbl_mark_idx tblmark where tblmark.Labelid in
                <foreach collection="param.tableMarks" item="id" index="index" open="(" close=")" separator=",">
                    #{id}
                </foreach>
                )
            </if>


            <!-- 如果填写字段名 -->
            <if test="param.fieldName != null and param.fieldName != ''">
                and tb.Data_Tblid in
                (
                select fld.Data_Tblid from data_fld fld where fld.Fld_Cn_Nm like CONCAT('%', #{param.fieldName, jdbcType=VARCHAR}, '%') OR fld.Fld_Phys_Nm like CONCAT('%', #{param.fieldName, jdbcType=VARCHAR}, '%')
                )
            </if>

            <!-- 如果勾选了数据字段标引 -->
            <if test="param.fieldMarks!=null and param.fieldMarks.length>0">
                and tb.Data_Tblid in
                (
                select fld.Data_Tblid from data_fld fld where fld.Fldid in
                (
                select fldmark.Fldid from data_fld_mark_idx fldmark where fldmark.Labelid in
                <foreach collection="param.fieldMarks" item="id" index="index" open="(" close=")" separator=",">
                    #{id}
                </foreach>
                )
                )
            </if>

            <!-- 选择脱敏 -->
            <if test="param.isDesen == '02'">
                AND tb.Data_Tblid in
                (
                    SELECT
                        idxtb.Data_Tblid
                    FROM
                        data_tbl_mark_idx idxtb,
                        label label
                    WHERE
                        idxtb.Labelid = label.Labelid AND label.Label_Cd = '__L000002__'
                )
            </if>
            <!-- 选择未脱敏 -->
            <if test="param.isDesen == '03'">
                AND tb.Data_Tblid not in
                (
                    SELECT
                        idxtb.Data_Tblid
                    FROM
                        data_tbl_mark_idx idxtb,
                        label label
                    WHERE
                        idxtb.Labelid = label.Labelid AND label.Label_Cd = '__L000002__'
                )
            </if>

            <if test="param.dbId != null">
                AND tb.Dbid = #{param.dbId}
            </if>

            AND tb.Data_Tblid in
            (
                SELECT
                    idxtb.Data_Tblid
                FROM
                    data_tbl_mark_idx idxtb,
                    label label
                WHERE
                    idxtb.Labelid = label.Labelid AND label.Label_Cd = '__L000001__'
            )

    </select>

    <select id="queryDesenDataList" parameterType="io.dfjinxin.modules.storage.dto.DesenForm" resultMap="dataTbDesenlMap">
        SELECT
            tb.Data_Tblid,
            tb.Dbid,
            tb.Data_Tbl_Phys_Nm,
            tb.Data_Tbl_Cn_Nm,
            tb.Data_Tbl_Desc,
            tb.Create_Dt,
            tb.Upd_Dt,
            tb.Del_Dt,
            tb.Incr_Or_Full,
            tb.Data_Tbl_UUID,
            tb.Data_Srcid,
            tdb.Db_Cn_Nm,
            (CASE WHEN tb.Create_Dt = CURRENT_DATE THEN '0' WHEN tb.Upd_Dt =CURRENT_DATE THEN '1' ELSE '2' END) metaStatus
        FROM
            data_tbl tb
            left join db tdb on tb.Dbid = tdb.Dbid
        WHERE
            tb.Del_Dt is null and
            tb.Dbid in (select db.Dbid from db db where db.Partid = #{param.partid})

            <!-- 如果填写表名称 -->
            <if test="param.tableName != null and param.tableName != ''">
                AND (tb.Data_Tbl_Cn_Nm like CONCAT('%', #{param.tableName, jdbcType=VARCHAR}, '%') OR tb.Data_Tbl_Phys_Nm like CONCAT('%', #{param.tableName, jdbcType=VARCHAR}, '%'))
            </if>

            <!-- 如果勾选了数据表标引 -->
            <if test="param.tableMarks!=null and param.tableMarks.length>0">
                AND  tb.Data_Tblid in
                (
                    select tblmark.Data_Tblid from data_tbl_mark_idx tblmark where tblmark.Labelid in
                    <foreach collection="param.tableMarks" item="id" index="index" open="(" close=")" separator=",">
                        #{id}
                    </foreach>
                )
            </if>


            <!-- 如果填写字段名 -->
            <if test="param.fieldName != null and param.fieldName != ''">
                and tb.Data_Tblid in
                    (
                        select fld.Data_Tblid from data_fld fld where fld.Fld_Cn_Nm like CONCAT('%', #{param.fieldName, jdbcType=VARCHAR}, '%') OR fld.Fld_Phys_Nm like CONCAT('%', #{param.fieldName, jdbcType=VARCHAR}, '%')
                    )
            </if>

            <!-- 如果勾选了数据字段标引 -->
            <if test="param.fieldMarks!=null and param.fieldMarks.length>0">
                and tb.Data_Tblid in
                (
                    select fld.Data_Tblid from data_fld fld where fld.Fldid in
                    (
                        select fldmark.Fldid from data_fld_mark_idx fldmark where fldmark.Labelid in
                        <foreach collection="param.fieldMarks" item="id" index="index" open="(" close=")" separator=",">
                            #{id}
                        </foreach>
                    )
                )
            </if>

            <!-- 选择脱敏 -->
            <if test="param.isDesen == '02'">
                AND tb.Data_Tblid in
                (
                    SELECT
                        idxtb.Data_Tblid
                    FROM
                        data_tbl_mark_idx idxtb,
                        label label
                    WHERE
                        idxtb.Labelid = label.Labelid AND label.Label_Cd = '__L000002__'
                )
            </if>
            <!-- 选择未脱敏 -->
            <if test="param.isDesen == '03'">
                AND tb.Data_Tblid not in
                (
                    SELECT
                        idxtb.Data_Tblid
                    FROM
                        data_tbl_mark_idx idxtb,
                        label label
                    WHERE
                        idxtb.Labelid = label.Labelid AND label.Label_Cd = '__L000002__'
                )
            </if>

            <if test="param.dbId != null">
                AND tb.Dbid = #{param.dbId}
            </if>
            AND tb.Data_Tblid in
            (
                SELECT
                    idxtb.Data_Tblid
                FROM
                    data_tbl_mark_idx idxtb,
                    label label
                WHERE
                    idxtb.Labelid = label.Labelid AND label.Label_Cd = '__L000001__'
            )
            ORDER BY metaStatus, tb.Data_Tbl_Cn_Nm DESC
            LIMIT #{param.start}, #{param.pageSize}
    </select>

    <select id="queryFldByTbId" parameterType="java.lang.Integer" resultType="io.dfjinxin.modules.storage.dto.DesenFld">
        SELECT
            t.fldid fldid,
            t.data_Tblid dataTblid,
            t.fld_Phys_Nm fldPhysNm,
            t.fld_Cn_Nm fldCnNm,
            b.Data_Wash_Cmpuid dataWashCmpuid,
            b.Paraid paraid
        FROM
            data_fld t
            LEFT JOIN data_fld_wash_proj b ON t.Fldid = b.Fldid
                AND b.Data_Wash_Cmpuid IN (
                    SELECT
                        c.Data_Wash_Cmpuid
                    FROM
                        data_wash_cmpu c
                    WHERE
                        c.Data_Wash_Cmpu_Type = 1
                )
        WHERE
		    t.Data_Tblid  = #{tbId} and t.fld_Phys_Nm not in ('rowidlwq', 'tagslwq')
		     order by t.Fld_Ord
    </select>

    <delete id="deleteDataFldWashProj" parameterType="java.lang.Integer">
        delete from
            data_fld_wash_proj
        where
            data_fld_wash_proj.Data_Wash_Cmpuid IN (
                    SELECT
                        c.Data_Wash_Cmpuid
                    FROM
                        data_wash_cmpu c
                    WHERE
                        c.Data_Wash_Cmpu_Type = 1
                )
            and data_fld_wash_proj.Fldid IN (select t.fldid from data_fld t where t.Data_Tblid  = #{tbId})
    </delete>

    <delete id="deletePrdDataFldWashProj" parameterType="java.lang.Integer">
        delete from
            prd_data_fld_wash_proj
        where
            prd_data_fld_wash_proj.Data_Wash_Cmpuid IN (
                    SELECT
                        c.Data_Wash_Cmpuid
                    FROM
                        data_wash_cmpu c
                    WHERE
                        c.Data_Wash_Cmpu_Type = 1
                )
            and prd_data_fld_wash_proj.Fldid IN (select t.fldid from data_fld t where t.Data_Tblid  = #{tbId})
    </delete>
</mapper>