<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.dfjinxin.modules.wash.dao.FldWashResultDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.dfjinxin.modules.wash.entity.FldWashResultEntity" id="fldWashResultMap">
        <result property="jobid" column="Jobid"/>
        <result property="fldid" column="Fldid"/>
        <result property="dataWashCmpuid" column="Data_Wash_Cmpuid"/>
        <result property="chkProjid" column="Chk_Projid"/>
        <result property="washRecQty" column="Wash_Rec_Qty"/>
    </resultMap>

    <!-- 发布清洗报告 -->
    <select id="washReport" resultType="map">
        select t1.Fldid,t1.Data_Tblid,t5.jobid, t1.Fld_Ord,t1.Fld_Cn_Nm,t1.Fld_Phys_Nm,
        t1.Fld_Data_Type,t1.If_Pk,t1.If_Can_Null,t3.Data_Wash_Cmpu_Nm,t3.Data_Wash_Cmpuid,
        t4.Wash_Rec_Qty,t4.Retn_Rec_Qty,
        t4.Wash_Rec_Qty,ROUND(t4.Wash_Rec_Qty/t5.Proc_Rec_Total_Qty*100,4) wash_pro,
        t4.Retn_Rec_Qty,ROUND(t4.Retn_Rec_Qty/t5.Proc_Rec_Total_Qty*100,4) ret_pro
        from  data_fld t1
        left join data_proc_job t5 on t5.Data_Tblid=t1.Data_Tblid
        left join fld_wash_result t4 on t4.Fldid = t1.Fldid and t4.jobid=t5.jobid
        left join data_wash_cmpu t3 on t3.Data_Wash_Cmpuid = t4.Data_Wash_Cmpuid and t3.Data_Wash_Cmpu_Type='0'
        where t5.Job_Stus = 'DONE' and t5.Job_Type = 1 and t5.Jobid = #{p.jobid}
        <if test="p.containsKey('projId') and p.projId != null and p.projId != ''" >
            and t3.Data_Wash_Cmpuid = #{p.projId}
        </if>
        order by t1.Fld_Ord asc
    </select>

    <!-- 报告探查项目 -->
    <select id="washProj" resultType="map">
        SELECT t3.Data_Wash_Cmpuid,t3.Data_Wash_Cmpu_Nm
        FROM  data_wash_cmpu t3
        LEFT JOIN fld_wash_result t2 ON t3.Data_Wash_Cmpuid = t2.Data_Wash_Cmpuid
        LEFT JOIN data_proc_job t4 ON t4.Jobid=t2.Jobid
        WHERE t4.Job_Stus = 'DONE' AND t4.Job_Type = 1 AND t3.Data_Wash_Cmpu_Type='0' AND t3.Data_Wash_Cmpuid IS NOT NULL
           AND t2.Jobid = #{Jobid}
           GROUP BY t3.Data_Wash_Cmpuid,t3.Data_Wash_Cmpu_Nm
	</select>

    <!-- 表探查结果总览 -->
    <select id="washInfo" resultType="map">
		SELECT t2.Data_Tbl_Cn_Nm,t2.Data_Tbl_Phys_Nm ,t3.Data_Src_Nm,t1.Data_Start_Dt,t1.Data_Terminate_Dt,COALESCE(t1.Data_Spl_Pct,0) Data_Spl_Pct,COALESCE(t1.Proc_Rec_Total_Qty,0) Proc_Rec_Total_Qty,COALESCE(t1.Pk_Dupl_Rec_Qty,0) Pk_Dupl_Rec_Qty,COALESCE(t1.All_Dupl_Rec_Qty,0) All_Dupl_Rec_Qty
         FROM data_proc_job t1
        LEFT JOIN data_tbl t2 ON t2.Data_Tblid = t1.Data_Tblid
        LEFT JOIN data_src t3 ON t3.Data_Srcid = t2.Data_Srcid

        WHERE 1=1
        AND t1.Jobid = #{Jobid}
	</select>

</mapper>