<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.dfjinxin.modules.wash.dao.PrdDataWashFldResultDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.dfjinxin.modules.wash.entity.PrdDataWashFldResultEntity" id="prdDataWashFldResultMap">
        <result property="jobid" column="Jobid"/>
        <result property="jobExecDate" column="Job_Exec_Date"/>
        <result property="fldid" column="Fldid"/>
        <result property="dataWashCmpuid" column="Data_Wash_Cmpuid"/>
        <result property="washRecQty" column="Wash_Rec_Qty"/>
        <result property="retnRecQty" column="Retn_Rec_Qty"/>
        <result property="jobExecTime" column="Job_Exec_Time"/>
    </resultMap>

    <select id="queryDataByJobid" parameterType="java.lang.Integer" resultType="io.dfjinxin.modules.wash.entity.PrdDataWashFldResultEntity">
       SELECT
            a.Jobid jobid,
            a.Job_Exec_Date jobExecDate,
            a.Fldid fldid,
            b.Fld_Phys_Nm fldPhysNm,
            b.Fld_Cn_Nm fldCnNm,
            Data_Wash_Cmpuid dataWashCmpuid,
            a.Wash_Rec_Qty washRecQty,
            a.Retn_Rec_Qty retnRecQty,
            a.Job_Exec_Time jobExecTime
        FROM
            Prd_Data_Wash_Fld_Result a
        LEFT JOIN data_fld b ON b.Fldid = a.Fldid
        WHERE
            a.Jobid = #{jobid}
    </select>


    <!-- 发布清洗报告 -->
    <select id="washReport" resultType="map">
        select x.*,ROUND(x.Wash_Rec_Qty/x.Proc_Rec_Total_Qty*100,4) wash_pro,ROUND(x.Retn_Rec_Qty/x.Proc_Rec_Total_Qty*100,4) ret_pro from (
        select t1.Fldid,t1.Data_Tblid,t5.jobid, t1.Fld_Ord,t1.Fld_Cn_Nm,t1.Fld_Phys_Nm,
        t1.Fld_Data_Type,t1.If_Pk,t1.If_Can_Null,t2.Data_Wash_Cmpu_Nm,t2.Data_Wash_Cmpuid,
        sum(t4.Wash_Rec_Qty) Wash_Rec_Qty, sum(t4.Retn_Rec_Qty) Retn_Rec_Qty, sum(t6.Proc_Rec_Total_Qty) Proc_Rec_Total_Qty
        from  data_fld t1
        left join prd_data_proc_job t5 on t5.Data_Tblid=t1.Data_Tblid
        left join prd_data_proc_job_result t6 on t6.Jobid=t5.Jobid and t6.Job_Exec_Date between #{p.date1} and #{p.date2}
        left join prd_data_wash_fld_result t4 on t4.Fldid = t1.Fldid and t4.jobid=t5.jobid and t6.Job_Exec_Date=t4.Job_Exec_Date
        left join data_wash_cmpu t2 on t4.Data_Wash_Cmpuid=t2.Data_Wash_Cmpuid and t2.Data_Wash_Cmpu_Type='0'
        where t5.Job_Type = 1 and t1.data_Tblid = #{p.tabaId}
        <if test="p.containsKey('projId') and p.projId != null and p.projId != ''" >
            and t2.Data_Wash_Cmpuid = #{p.projId}
        </if>
        group by t1.Fldid,t1.Data_Tblid,t5.jobid, t1.Fld_Ord,t1.Fld_Cn_Nm,t1.Fld_Phys_Nm,
        t1.Fld_Data_Type,t1.If_Pk,t1.If_Can_Null,t2.Data_Wash_Cmpu_Nm,t2.Data_Wash_Cmpuid
        ) x
        order by x.Fld_Ord asc
    </select>

    <!-- 报告探查项目 -->
    <select id="washProj" resultType="map">
        SELECT distinct t3.Data_Wash_Cmpuid,t3.Data_Wash_Cmpu_Nm FROM prd_data_proc_job t1
        LEFT JOIN prd_data_wash_fld_result t2 ON t1.Jobid = t2.Jobid
        LEFT JOIN data_wash_cmpu t3 ON t2.Data_Wash_Cmpuid = t3.Data_Wash_Cmpuid
        WHERE t3.Data_Wash_Cmpuid IS NOT NULL and t3.Data_Wash_Cmpu_Type='0'
         AND t1.Data_Tblid = #{p.tabaId} and t2.Job_Exec_Date=#{p.date1}
        GROUP BY t3.Data_Wash_Cmpuid
	</select>

    <!-- 数据源列表 -->
    <select id="dataSrcList" resultType="map">
		SELECT t1.Data_Srcid,t1.Data_Src_Nm FROM data_src t1
        LEFT JOIN department t2 ON t1.Department_Id = t2.department_id
        WHERE 1=1
        and  t2.tnmtid = #{p.tnmtid}

	</select>

    <!-- 表探查结果总览 -->
    <select id="washInfo" resultType="map">
		SELECT t3.Data_Tbl_Cn_Nm,t4.Data_Src_Nm,t1.Job_Release_Date,t1.Job_Start_Time,t1.Job_Finish_Time,t2.Job_Exec_Date
		,t2.Proc_Rec_Total_Qty,t2.All_Pass_Rec_Qty,t2.All_Dupl_Rec_Qty,t2.Pk_Dupl_Rec_Qty
        FROM prd_data_proc_job t1
        LEFT JOIN prd_data_proc_job_result t2 ON t1.Jobid = t2.Jobid
        LEFT JOIN data_tbl t3 ON t3.Data_Tblid = t1.Data_Tblid
        LEFT JOIN data_src t4 ON t4.Data_Srcid = t3.Data_Srcid
        WHERE 1=1
        AND t2.Job_Exec_Date between #{p.date1} and #{p.date2}
        AND t3.Data_Tblid = #{p.tabaId}
	</select>


    <!-- 表探查结果 -->
    <select id="tableFld" resultType="map">
		SELECT t.Fldid,t.Fld_Phys_Nm prop,t.Fld_Cn_Nm label,t3.Db_Phys_Nm,MAX(t4.Dp_Dt) Dp_Dt,t2.Data_Tbl_Phys_Nm FROM data_fld t
        LEFT JOIN data_tbl t2 ON t2.Data_Tblid = t.Data_Tblid
        LEFT JOIN db t3 ON t2.Dbid = t3.Dbid
        LEFT JOIN dp t4 ON t4.Data_Tblid = t2.Data_Tblid
    WHERE 1=1
     AND t.Data_Tblid = #{p.tabId}
    GROUP BY t.Fldid
    ORDER BY t.Fld_Ord
	</select>

    <!-- 字段问题分布结果 -->
    <select id="fieldProInfo" resultType="map">
        select x.Data_Wash_Cmpu_Nm,x.wqty,x.qty,(x.wqty+x.qty) cnt,y.ttl,ROUND((x.wqty+x.qty)/y.ttl*100,4) pro from (
            select s1.Data_Wash_Cmpu_Nm,sum(s2.Proc_Rec_Total_Qty) ttl, s1.wqty
                  ,sum(ifnull(case when s1.Data_Wash_Cmpu_Nm='主键重复' then s2.Pk_Dupl_Rec_Qty when s1.Data_Wash_Cmpu_Nm='全字段重复' then s2.All_Dupl_Rec_Qty else s1.qty end,0)) qty
            from (
                select sum(Proc_Rec_Total_Qty) Proc_Rec_Total_Qty,sum(Pk_Dupl_Rec_Qty) Pk_Dupl_Rec_Qty,sum(All_Dupl_Rec_Qty) All_Dupl_Rec_Qty, 0 wqty
                from prd_data_proc_job_result r1
                left join prd_data_proc_job r2 on r1.jobid=r2.jobid
                left join data_tbl r3 on r3.data_tblid=r2.data_tblid
                where r3.data_tblid = #{p.tabaId} and r1.Job_Exec_Date between #{p.date1} and #{p.date2}
            ) s2,(
                select t3.Data_Wash_Cmpu_Nm,sum(t2.Retn_Rec_Qty) qty, sum(t2.Wash_Rec_Qty) wqty
                from prd_data_wash_fld_result t2
                left join prd_data_proc_job t1 on t1.jobid=t2.jobid
                left join data_tbl t4 on t4.data_tblid=t1.data_tblid
                left join data_wash_cmpu t3 on t2.Data_Wash_Cmpuid = t3.Data_Wash_Cmpuid
                where t1.Job_Type=1 and t3.Data_Wash_Cmpu_Type='0'
                  and t4.data_tblid = #{p.tabaId} and t2.Job_Exec_Date between #{p.date1} and #{p.date2}
                group by t3.Data_Wash_Cmpu_Nm
                union select '主键重复',0,0
                union select '全字段重复',0,0
            ) s1
            group by s1.Data_Wash_Cmpu_Nm
        ) x ,(
            select sum(s3.ttl) ttl from (
            select sum(a1.Pk_Dupl_Rec_Qty+a1.All_Dupl_Rec_Qty) ttl
            from prd_data_proc_job_result a1
            left join prd_data_proc_job a2 on a1.jobid=a2.jobid
            left join data_tbl a3 on a2.data_tblid=a3.data_tblid
            where a3.data_tblid = #{p.tabaId} and a1.Job_Exec_Date between #{p.date1} and #{p.date2}
            union all
            select sum(b1.Retn_Rec_Qty+b1.Wash_Rec_Qty) ttl
            from prd_data_wash_fld_result b1
            left join prd_data_proc_job b2 on b1.jobid=b2.jobid
            left join data_tbl b3 on b2.data_tblid=b3.data_tblid
            left join data_wash_cmpu b4 on b1.Data_Wash_Cmpuid = b4.Data_Wash_Cmpuid and b4.Data_Wash_Cmpu_Type='0'
            where b3.data_tblid = #{p.tabaId} and b1.Job_Exec_Date between #{p.date1} and #{p.date2}
            ) s3
        ) y
	</select>

    <select id="tableReport" resultType="map">
        select * from (
        <if test="p.containsKey('range') and p.range != null and p.range != '' and p.range == 2">
            SELECT m1.Data_Srcid,m1.Data_Src_Nm,COUNT(distinct m3.Data_Tblid) qty,
            COUNT(distinct m4.Data_Tblid) washQty,COUNT(distinct m5.Data_Tblid) proQty
            FROM data_src m1
            LEFT JOIN department m2 ON m1.Department_Id = m2.department_id
            LEFT JOIN data_tbl m3 ON m1.Data_Srcid = m3.Data_Srcid
            LEFT JOIN (
                select a1.Data_Tblid, a2.jobid,a2.Job_Exec_Date
                from prd_data_proc_job a1 LEFT JOIN prd_data_proc_job_result a2 ON a1.Jobid = a2.Jobid
                where a1.job_type=1 and a2.jobid is not null
            ) m4 ON m4.Data_Tblid = m3.Data_Tblid and #{p.date} >= m4.Job_Exec_Date
            LEFT JOIN db m6 on m3.Dbid = m6.Dbid
            LEFT JOIN (
                SELECT q1.Data_Tblid,q2.Job_Exec_Date FROM prd_data_proc_job q1
                LEFT JOIN prd_data_proc_job_result q2 ON q1.Jobid = q2.Jobid
                LEFT JOIN data_tbl q3 ON q3.Data_Tblid = q1.Data_Tblid
                where q1.Job_Type=1 and (q2.All_Dupl_Rec_Qty>0 or q2.Pk_Dupl_Rec_Qty>0 or q2.Proc_Rec_Total_Qty>q2.All_Pass_Rec_Qty)
                GROUP BY q1.Data_Tblid
                union
                SELECT p1.Data_Tblid,p2.Job_Exec_Date FROM prd_data_proc_job p1
                LEFT JOIN prd_data_wash_fld_result p2 ON p1.Jobid = p2.Jobid
                LEFT JOIN data_tbl p3 ON p3.Data_Tblid = p1.Data_Tblid
                where p1.Job_Type=1 and p2.Retn_Rec_Qty>0
                GROUP BY p1.Data_Tblid
            ) m5 ON m5.Data_Tblid=m3.Data_Tblid and #{p.date} >= m5.Job_Exec_Date
            WHERE m3.Del_Dt is null and m6.Db_usageid=2
            AND m2.tnmtid = #{p.tnmtid}
            <if test="p.containsKey('srcName') and p.srcName != null and p.srcName != ''">
                AND m1.Data_Src_Nm LIKE concat('%',#{p.srcName},'%')
            </if>
            <if test="p.containsKey('freq') and p.freq != null and p.freq != ''">
                AND m3.Load_Freq = #{p.freq}
            </if>
            GROUP BY m1.Data_Srcid,m1.Data_Src_Nm
        </if>
        <if test="!p.containsKey('range') or p.range == null or p.range == '' or p.range == 3">
            SELECT m1.Data_Srcid,m1.Data_Src_Nm,COUNT(distinct m3.Data_Tblid) qty,
            COUNT(distinct m4.Data_Tblid) washQty,COUNT(distinct m5.Data_Tblid) proQty
            FROM data_tbl m3
            LEFT JOIN db d ON m3.Dbid=d.Dbid
            LEFT JOIN data_part m2 ON m2.Partid=d.Partid
            LEFT JOIN data_src m1 ON m1.Data_Srcid = m3.Data_Srcid
            LEFT JOIN (
                select a1.Data_Tblid, a2.jobid,a2.Job_Exec_Date
                from prd_data_proc_job a1 LEFT JOIN prd_data_proc_job_result a2 ON a1.Jobid = a2.Jobid
                where a1.job_type=1 and a2.jobid is not null
            ) m4 ON m4.Data_Tblid = m3.Data_Tblid and #{p.date} >= m4.Job_Exec_Date
            LEFT JOIN (
                SELECT q1.Data_Tblid,q2.Job_Exec_Date FROM prd_data_proc_job q1
                LEFT JOIN prd_data_proc_job_result q2 ON q1.Jobid = q2.Jobid
                LEFT JOIN data_tbl q3 ON q3.Data_Tblid = q1.Data_Tblid
                where q1.Job_Type=1 and (q2.All_Dupl_Rec_Qty>0 or q2.Pk_Dupl_Rec_Qty>0 or q2.Proc_Rec_Total_Qty>q2.All_Pass_Rec_Qty)
                GROUP BY q1.Data_Tblid
                union
                SELECT p1.Data_Tblid,p2.Job_Exec_Date FROM prd_data_proc_job p1
                LEFT JOIN prd_data_wash_fld_result p2 ON p1.Jobid = p2.Jobid
                LEFT JOIN data_tbl p3 ON p3.Data_Tblid = p1.Data_Tblid
                where p1.Job_Type=1 and p2.Retn_Rec_Qty>0
                GROUP BY p1.Data_Tblid
            ) m5 ON m5.Data_Tblid=m3.Data_Tblid and #{p.date} >=  m5.Job_Exec_Date
            WHERE m3.Del_Dt is null and d.Db_usageid=2
            AND m2.tnmtid = #{p.tnmtid}
            <if test="p.containsKey('srcName') and p.srcName != null and p.srcName != ''">
                AND m1.Data_Src_Nm LIKE concat('%',#{p.srcName},'%')
            </if>
            <if test="p.containsKey('freq') and p.freq != null and p.freq != ''">
                AND m3.Load_Freq = #{p.freq}
            </if>
            GROUP BY m1.Data_Srcid,m1.Data_Src_Nm
        </if>
        ) x
    </select>

    <select id="tableReportInfo" resultType="map">
        select x.*,CASE WHEN x.Proc_Rec_Total_Qty > 0 THEN ROUND((1-x.All_Pass_Rec_Qty/x.Proc_Rec_Total_Qty)*100,2) ELSE 0 END pro from (
            select t2.Data_Tblid,t2.Data_Tbl_Cn_Nm,t2.Data_Tbl_Phys_Nm,t4.Jobid,t4.Job_Exec_Date,sum(ifnull(t4.Proc_Rec_Total_Qty,0)) Proc_Rec_Total_Qty,
            sum(ifnull(t4.Proc_Rec_Total_Qty - t4.All_Pass_Rec_Qty,0)) Pro_Qty,sum(ifnull(t4.All_Pass_Rec_Qty,0)) All_Pass_Rec_Qty
            from data_tbl t2
            left join db t5 on t2.Dbid=t5.Dbid
            left join data_part t9 on t5.Partid=t9.Partid
            left join data_src t7 on t7.Data_Srcid=t2.Data_Srcid
            left join department t8 on t7.department_id=t8.department_id
            left join prd_data_proc_job t3 on t3.Data_Tblid = t2.Data_Tblid and t3.job_type=1
            left join prd_data_proc_job_result t4 on t4.Jobid = t3.Jobid and t4.Job_Exec_Date between #{p.date1} and #{p.date2}
            where t2.Del_Dt is null and t5.Db_usageid=2
            <if test="p.containsKey('range') and p.range != null and p.range == 2" >
                and t8.Tnmtid=#{p.tenantId}
            </if>
            <if test="p.containsKey('range') and p.range != null and p.range == 3" >
                and t9.Tnmtid=#{p.tenantId}
            </if>
            <if test="p.containsKey('srcId') and p.srcId != null and p.srcId != 0" >
                and t2.Data_Srcid = #{p.srcId}
            </if>
            <if test="p.containsKey('srcId') and p.srcId != null and p.srcId == 0" >
                and t2.Data_Srcid is null
            </if>
            <if test="p.containsKey('freq') and p.freq != null and p.freq != ''" >
                and t2.Load_Freq = #{p.freq}
            </if>
            <if test="p.containsKey('name') and p.name != null and p.name != ''" >
                and (t2.Data_Tbl_Cn_Nm LIKE concat('%',#{p.name},'%') or t2.Data_Tbl_Phys_Nm LIKE concat('%',#{p.name},'%') )
            </if>
            group by t2.Data_Tblid,t2.Data_Tbl_Cn_Nm,t2.Data_Tbl_Phys_Nm,t4.Jobid
        ) x
        order by x.Data_Tblid
    </select>

    <select id="tableProInfo" resultType="map">
        select m1.*,m2.ttl,ROUND(m1.qty/m2.ttl*100,2) pro from (
              select t3.Data_Wash_Cmpu_Nm,count(distinct t4.Data_Tblid) qty
              from prd_data_fld_wash_proj t0
              left join prd_data_wash_fld_result t2 on t0.Fldid=t2.Fldid and t0.Data_Wash_Cmpuid=t2.Data_Wash_Cmpuid
              left join data_wash_cmpu t3 on t2.Data_Wash_Cmpuid=t3.Data_Wash_Cmpuid
              left join data_fld t1 on t2.Fldid=t1.Fldid
              left join data_tbl t4 on t4.Data_Tblid = t1.Data_Tblid
              left join data_src t5 on t5.Data_Srcid = t4.Data_Srcid
              left join db t7 on t4.Dbid=t7.Dbid
              left join data_part t8 on t8.Partid=t7.Partid
              left join department t9 on t9.department_id=t5.Department_Id
              left join (select max(jobid) jobid,Data_Tblid from prd_data_proc_job where job_type=1 group by data_tblid) t6 on t4.Data_Tblid=t6.Data_Tblid and t2.Jobid=t6.jobid
              where t3.Data_Wash_Cmpu_Type=0 and t7.Db_usageid=2 and t5.Data_Srcid=#{p.id} and t2.Job_Exec_Date between #{p.date1} and #{p.date2}
                <if test="p.containsKey('range') and p.range != null and p.range == 2" >
                    and t8.Tnmtid=#{p.tenantId}
                </if>
                <if test="p.containsKey('range') and p.range != null and p.range == 3" >
                    and t9.Tnmtid=#{p.tenantId}
                </if>
              group by t3.Data_Wash_Cmpu_Nm
              union all
              select n2.proj,(case when n2.proj='主键重复' then qty1 else qty2 end) qty from
              (select sum(case when a3.All_Dupl_Rec_Qty>0 then 1 else 0 end) qty1,
                      sum(case when a3.Pk_Dupl_Rec_Qty>0 then 1 else 0 end) qty2
                from data_tbl a1
                left join data_src t5 on t5.Data_Srcid = a1.Data_Srcid
                left join db t7 on a1.Dbid=t7.Dbid
                left join data_part t8 on t8.Partid=t7.Partid
                left join department t9 on t9.department_id=t5.Department_Id
                left join (select max(jobid) jobid,Data_Tblid from prd_data_proc_job where job_type=1 group by data_tblid) a2 on a1.Data_Tblid=a2.Data_Tblid
                left join prd_data_proc_job_result a3 on a3.jobid=a2.jobid
                where t7.Db_usageid=2 and a1.Data_Srcid=#{p.id} and a3.Job_Exec_Date between #{p.date1} and #{p.date2}
                <if test="p.containsKey('range') and p.range != null and p.range == 2" >
                    and t8.Tnmtid=#{p.tenantId}
                </if>
                <if test="p.containsKey('range') and p.range != null and p.range == 3" >
                    and t9.Tnmtid=#{p.tenantId}
                </if>
                ) n1,(select '主键重复' proj union select '全字段重复' pr) n2 where (n1.qty1 is not null or n1.qty2 is not null)
        ) m1,(select COUNT(t4.Data_Tblid) ttl
                from data_tbl t4
                left join data_src t5 on t5.Data_Srcid = t4.Data_Srcid
                left join db t7 on t4.Dbid=t7.Dbid
                left join data_part t8 on t8.Partid=t7.Partid
                left join department t9 on t9.department_id=t5.Department_Id
               where t4.Data_Srcid=#{p.id} and t4.Del_Dt is null and t7.Db_usageid=2
                <if test="p.containsKey('range') and p.range != null and p.range == 2" >
                    and t8.Tnmtid=#{p.tenantId}
                </if>
                <if test="p.containsKey('range') and p.range != null and p.range == 3" >
                    and t9.Tnmtid=#{p.tenantId}
                </if>
        ) m2
    </select>

    <select id="lastExecDate" resultType="String">
      select ifnull(max(t3.Job_Exec_Date),'') Job_Exec_Date from data_tbl t1
      left join prd_data_proc_job t2 on t2.Data_Tblid=t1.Data_Tblid and t2.Job_Type=1
      left join prd_data_proc_job_result t3 on t2.jobid=t3.jobid
      where t1.Del_Dt is null and t3.Proc_Rec_Total_Qty>0
      <if test="p.containsKey('id') and p.id != null and p.id != ''">
          and t1.Data_Srcid = #{p.id}
      </if>
    </select>
</mapper>