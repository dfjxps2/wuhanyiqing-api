<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.dfjinxin.modules.wash.dao.FldExplResultDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.dfjinxin.modules.wash.entity.FldExplResultEntity" id="fldExplResultMap">
        <result property="jobid" column="Jobid"/>
        <result property="fldid" column="Fldid"/>
        <result property="chkProjid" column="Chk_Projid"/>
        <result property="isuRecQty" column="Isu_Rec_Qty"/>
    </resultMap>

    <!-- 探查报告 -->
    <select id="expReport" resultType="map">
        select t1.Fldid,t1.Fld_Cn_Nm,t1.Fld_Phys_Nm,t1.Fld_Data_Type,t1.If_Pk,t1.If_Can_Null,
        t4.Chk_Proj_Nm,t6.Isu_Rec_Qty,
        CASE WHEN t5.Proc_Rec_Total_Qty IS NOT NULL AND t5.Proc_Rec_Total_Qty >0  AND t6.Isu_Rec_Qty IS NOT NULL THEN ROUND(t6.Isu_Rec_Qty/t5.Proc_Rec_Total_Qty*100,4) ELSE 0 END Exc_Pro
        from data_fld t1
        left join data_proc_job t5 on t5.Data_Tblid=t1.Data_Tblid
        left join fld_expl_result t6 on t6.Fldid = t1.Fldid and t6.Jobid = t5.Jobid
        left join data_chk_proj t4 on t6.Chk_Projid=t4.Chk_Projid
        where t5.Job_Stus = 'DONE' and t5.Job_Type = 0 and t5.Jobid = #{p.jobid}
        <if test="p.containsKey('chk_projid') and p.chk_projid != null and p.chk_projid != '' and p.chk_projid != '0'" >
            and t4.Chk_Projid = #{p.chk_projid}
        </if>
        order by t1.Fld_Ord asc
    </select>

    <!-- 探查项目 -->
    <select id="expProj" resultType="map">
		SELECT d5.Chk_Projid,d5.Chk_Proj_Nm
        FROM data_proc_job d1
        LEFT JOIN fld_expl_result d2 ON d1.Jobid = d2.Jobid
        LEFT JOIN data_tbl d3 ON d1.Data_Tblid = d3.Data_Tblid
        LEFT JOIN data_fld d4 ON d3.Data_Tblid = d4.Data_Tblid AND d4.Fldid = d2.Fldid
        LEFT JOIN data_chk_proj d5 ON d2.Chk_Projid = d5.Chk_Projid
        WHERE d1.Job_Stus = 'DONE'
        AND d5.Chk_Proj_Cd IS NOT NULL
        AND d1.Jobid = #{Jobid}
        GROUP BY d5.Chk_Projid

	</select>

    <!-- 表探查结果 -->
    <select id="expInfo" resultType="map">
		SELECT c2.Data_Tbl_Cn_Nm,c2.Data_Tbl_Phys_Nm,c4.Data_Src_Nm,c1.Data_Start_Dt,c1.Data_Terminate_Dt,
        COALESCE( c1.Data_Spl_Pct) Data_Spl_Pct,COALESCE(c1.Proc_Rec_Total_Qty,0) Proc_Rec_Total_Qty,COALESCE(c1.All_Dupl_Rec_Qty,0) All_Dupl_Rec_Qty,COALESCE(c1.Pk_Dupl_Rec_Qty,0) Pk_Dupl_Rec_Qty
             FROM data_proc_job c1
            LEFT JOIN data_tbl c2 ON c1.data_tblid = c2.data_tblid
            LEFT JOIN data_src c4 ON c2.Data_Srcid =c4.Data_Srcid
             WHERE c1.Job_Stus = 'DONE'
        AND c1.Jobid = #{Jobid}
	</select>
</mapper>